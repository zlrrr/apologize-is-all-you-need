name: Deploy to Render

on:
  # ÊâãÂä®Ëß¶Âèë
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

  # Êé®ÈÄÅÂà∞mainÂàÜÊîØÊó∂Ëá™Âä®Ëß¶Âèë
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'render.yaml'
      - '.github/workflows/deploy-render.yml'

  # Pull RequestÊó∂ËøêË°åÊ£ÄÊü•Ôºà‰∏çÈÉ®ÁΩ≤Ôºâ
  pull_request:
    branches:
      - main
    paths:
      - 'backend/**'

jobs:
  # Job 1: ‰ª£Á†ÅÊ£ÄÊü•ÂíåÊµãËØï
  check:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Run TypeScript type check
        working-directory: backend
        run: npx tsc --noEmit

      - name: Run tests
        working-directory: backend
        run: npm test
        continue-on-error: true  # ÊµãËØïÂ§±Ë¥•‰∏çÈòªÊ≠¢ÈÉ®ÁΩ≤

      - name: Check build
        working-directory: backend
        run: npm run build

  # Job 2: ÈÉ®ÁΩ≤Âà∞Render
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: check
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Triggering Render deployment..."

          # Ëß¶ÂèëRenderÈÉ®ÁΩ≤
          curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{
              "clearCache": "do_not_clear"
            }'

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          sleep 60  # Á≠âÂæÖ60ÁßíËÆ©ÈÉ®ÁΩ≤ÂºÄÂßã

      - name: Check deployment health
        env:
          RENDER_SERVICE_URL: ${{ secrets.RENDER_SERVICE_URL }}
        run: |
          echo "Checking service health..."
          max_attempts=10
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -f "${RENDER_SERVICE_URL}/api/health" > /dev/null 2>&1; then
              echo "‚úÖ Service is healthy!"
              exit 0
            else
              echo "‚è≥ Waiting for service... (attempt $((attempt + 1))/$max_attempts)"
              sleep 10
              attempt=$((attempt + 1))
            fi
          done

          echo "‚ùå Service health check failed"
          exit 1

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "üéâ Deployment successful!"
            echo "Backend URL: ${{ secrets.RENDER_SERVICE_URL }}"
          else
            echo "‚ùå Deployment failed!"
          fi

  # Job 3: ÈÉ®ÁΩ≤ÂêéÊµãËØï
  post-deploy-test:
    name: Post-deployment Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Test health endpoint
        env:
          RENDER_SERVICE_URL: ${{ secrets.RENDER_SERVICE_URL }}
        run: |
          echo "Testing health endpoint..."
          response=$(curl -s "${RENDER_SERVICE_URL}/api/health")
          echo "Response: $response"

          if echo "$response" | grep -q "healthy\|ok"; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ùå Health check failed"
            exit 1
          fi

      - name: Test LLM health endpoint
        env:
          RENDER_SERVICE_URL: ${{ secrets.RENDER_SERVICE_URL }}
        run: |
          echo "Testing LLM health endpoint..."
          response=$(curl -s "${RENDER_SERVICE_URL}/api/health/llm")
          echo "Response: $response"

      - name: Test auth status endpoint
        env:
          RENDER_SERVICE_URL: ${{ secrets.RENDER_SERVICE_URL }}
        run: |
          echo "Testing auth status endpoint..."
          response=$(curl -s "${RENDER_SERVICE_URL}/api/auth/status")
          echo "Response: $response"
